---
title: "CARAMeL heatmap visualization"
author: "Carolina H. Chung"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_notebook: 
    code_folding: hide
---

This is an R Markdown Notebook for visualizing heatmaps from CARAMeL manuscript. 

# Set up environment

Install and load required pakcages.

```{r install packages, include=F}

# svDialogs (for popup user input)
  install.packages('svDialogs')

# dplyr (for piping functions)
  install.packages('dplyr')

# readxl (for reading Excel files)
  install.packages('readxl')

# pheatmap (for pretty heatmaps)
  if (!require("devtools")) {
    install.packages("devtools", dependencies = TRUE)
    library(devtools)
  }
  install_github("raivokolde/pheatmap")
  
# RColorBrewer (for custom color palettes)
  install.packages('RColorBrewer')

```

```{r load packages, include=F}

  library(svDialogs)
  library(dplyr)
  library(readxl)
  library(pheatmap)
  library(RColorBrewer)
  
```

# Load data 

Load data to visualize. Specifically: 

- *E. coli* drug-media interactions (Biolog)
- *E. coli* CARAMeL model predictions

```{r load data}

# Create dataset variable
  dataset <- list()
  
# EC (Biolog)
  dataset$EC$bio <- read_excel('results/plot_data.xlsx', sheet='ecoli_biolog')
  
# EC (predictions)
  dataset$EC$pred <- read_excel('results/plot_data.xlsx', sheet='pred_heatmap')
  
# Color palette
  col <- c(brewer.pal(9, 'Set1'), brewer.pal(3, 'Accent'))
  
# Save plots?
  save.plot <- dlgInput("Save heatmaps? (T/F)", Sys.info()['F'])$res

```

# Generate plots

Visualize all *E. coli* and *M. tb* results.

```{r E. coli interactions (Biolog), warning = F}

# Re-organize data
  dataset$EC$bio$Media <- dataset$EC$bio$Media %>% 
    factor(., levels=unique(.))
  y <- dataset$EC$bio[, -c(1:2)]
  rownames(y) <- dataset$EC$bio$Media
  
# Define metadata
  gx <- data.frame(Simulated=dataset$EC$bio$Simulatable %>% 
                     factor(., levels=unique(.)))
  rownames(gx) <- rownames(y)
  gy <- data.frame(Subset=c(rep('train', 4), rep('test', 2)) %>% 
                    factor(., levels=unique(.)), 
                   Target=c(rep('Cell wall', 2), 
                            rep('Protein synthesis, 30S', 2), 
                            rep('Multiple mechanisms', 2)) %>% 
                    factor(., levels=unique(.)))
  rownames(gy) <- colnames(y)
  
# Use RedBlue color palette (asymmetric)
  col.pal <- colorRampPalette(colors=c("snow2", "orchid3"),space="Lab")(100)
  
# Define annotation colors
  col.annot <- list(Simulated=c(Yes='limegreen', No='gray'), 
                    Subset=c(train='lightgoldenrod', test='green4'), 
                    Target=c(`Cell wall`='darkorange', 
                             `Protein synthesis, 30S`='turquoise3',
                             `Multiple mechanisms`='sienna'))
  names(col.annot$Simulated) <- levels(gx$Simulated)
  names(col.annot$Subset) <- levels(gy$Subset)
  names(col.annot$Target) <- levels(gy$Target)
  gz <- data.frame(Target=gy$Target)
  rownames(gz) <- rownames(gy)

# Visualize plot
  p1 <- pheatmap(t(y), cluster_rows=F, cluster_cols=F, gaps_row=4, gaps_col=96,
           legend_breaks=c(min(y), 0.5, 1, 1.5, max(y)-0.05), border_color=T,
           legend_labels=c('0','0.5','1','1.5','Respiration'),
           annotation_row=gz, annotation_col=gx, annotation_colors=col.annot,
           color=col.pal, angle_col='90', show_colnames=F, cellheight=15,
           cellwidth=2, main='Drug-media interactions')
  p1
  
# Save plot (if prompted)
  if (save.plot) {
    tiff('results/biolog_heatmap.tiff', units='in', width=7, height=2.5, res=300)
    print({
      p1
    })
    dev.off()
  }

```

```{r E. coli predictions, warning = F}

# Re-organize data
  y <- dataset$EC$pred[, -1]
  rownames(y) <- dataset$EC$pred$Pair
  
# Use RedBlue color palette (asymmetric)
  n <- round(100*(max(y) - min(y)))
  x <- n + round(100*min(y))
  col.neg <- colorRampPalette(colors=c("royalblue3", "white"), 
                              space="Lab")(abs(round(100*min(y))))
  col.pos <- colorRampPalette(colors=c("white", "red4"), 
                              space="Lab")(abs(round(100*max(y))))
  col.pal <- c(col.neg, col.pos)

# Visualize plot
  p2 <- pheatmap(y, cluster_rows=F, cluster_cols=F, gaps_col=c(55, 110),
           clustering_distance_rows='manhattan', color=col.pal, 
           legend_breaks=c(min(y)+0.03, 0, max(y)-0.03), border_color=NA, 
           legend_labels=c('Synergy','Neutral','Antagonism'), 
           show_rownames=F, show_colnames=F, cellheight=1.5, cellwidth=1.5)
  p2
  
# Save plot (if prompted)
  if (save.plot) {
    tiff('results/pred_heatmap.tiff', units='in', width=5, height=4.2, res=300)
    print({
      p2
    })
    dev.off()
  }

```

